name: Deploy Lure Application to Server

on:
  # Dispara o workflow em push para a branch 'refact/nginx'.
  # IMPORTANTE: Altere 'refact/nginx' para a sua branch principal de deploy (ex: 'main' ou 'pipeline') quando estiver pronto.
  push:
    branches: [ "refact/nginx" ]

  # Permite que você rode este workflow manualmente pela aba Actions
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy Application
    runs-on: self-hosted # Este job roda diretamente no seu servidor

    steps:
      # Passo 1: Baixar o código mais recente do repositório
      - name: Check out repository
        uses: actions/checkout@v4

      # Passo 2: Parar, reconstruir e iniciar toda a aplicação com Docker Compose
      #   - 'docker-compose down' para e remove os containers antigos para uma atualização limpa.
      #   - 'docker-compose up --build -d' reconstrói as imagens que mudaram (como o nosso proxy) e sobe a nova versão.
      - name: Rebuild and Deploy Docker Stack
        run: |
          docker-compose down
          docker-compose up --build -d

      # Passo 3: (Opcional, mas recomendado) Limpa imagens Docker antigas e não utilizadas para liberar espaço em disco.
      - name: Clean up old Docker images
        run: docker image prune -f
